<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á ‚ú®</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body {
      background: linear-gradient(to bottom right, #111111, #333333);
      color: #eeeeee;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      font-family: 'Arial', sans-serif;
      animation: fadeIn 1s ease;
    }

    .goal-item {
      background: #1c1c1c;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
      padding: 20px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      flex-wrap: wrap;
    }
    .goal-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(255, 255, 255, 0.15);
    }

    .goal-image-container {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      overflow: hidden;
      margin-right: 16px;
      background: #444;
      animation: popIn 0.6s ease;
      flex-shrink: 0;
    }
    .goal-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .add-new-goal-btn {
      width: 100%;
      background: #444;
      color: #fff;
      padding: 12px;
      border-radius: 10px;
      font-weight: bold;
      margin-bottom: 16px;
      transition: background 0.3s ease;
    }
    .add-new-goal-btn:hover {
      background: #666;
    }

    .popup,
    .goal-details-popup,
    #add-savings-popup {
      background: #222;
      color: #eee;
      border-radius: 12px;
      padding: 30px 40px 40px 40px;
      box-shadow: 0 6px 20px rgba(255, 255, 255, 0.2);
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      z-index: 20;
      animation: popIn 0.5s ease forwards;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      width: 400px;
    }

    .popup label,
    .goal-details-popup label,
    #add-savings-popup label {
      color: #ccc;
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
    }
    .popup input,
    .goal-details-popup input,
    #add-savings-popup input {
      background: #333;
      border: 1px solid #555;
      color: #eee;
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 1rem;
    }

    .popup button,
    .goal-details-popup button,
    #add-savings-popup button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s ease;
      margin-right: 10px;
      margin-top: 8px;
    }
    .popup button.confirm,
    #add-savings-popup button.confirm {
      background: #4caf50;
      color: #fff;
    }
    .popup button.cancel,
    .goal-details-popup button,
    #add-savings-popup button.cancel {
      background: #f44336;
      color: #fff;
    }
    .popup button:hover,
    .goal-details-popup button:hover,
    #add-savings-popup button:hover {
      opacity: 0.8;
    }

    .goal-actions button {
      background: #555;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.9rem;
      margin-left: 8px;
      transition: background 0.3s ease;
      color: #eee;
      border: none;
      cursor: pointer;
      margin-top: 6px;
    }
    .goal-actions button:hover {
      background: #777;
    }

    .progress-ring-large svg {
      transform: rotate(-90deg);
      display: block;
      margin: 0 auto;
    }
    .progress-ring-large circle:first-child {
      stroke: #555;
    }
    .progress-ring-large circle:last-child {
      stroke: #eee;
      transition: stroke-dashoffset 0.3s ease;
    }
    #details-progress-percent {
      fill: #eee;
      font-weight: 700;
    }

    a {
      color: #aaa;
      text-decoration: underline;
      transition: color 0.3s;
    }
    a:hover {
      color: #fff;
    }

    h1,
    h2 {
      color: #fff;
      margin-bottom: 16px;
    }

    /* --- ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô --- */
    @keyframes fadeIn {
      0% {
        opacity: 0;
        transform: scale(0.95);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes popIn {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
      }
      100% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    /* Responsive tweaks */
    @media (max-width: 480px) {
      .goal-item {
        flex-direction: column;
        align-items: flex-start;
      }
      .goal-image-container {
        margin-bottom: 12px;
        margin-right: 0;
      }
      .goal-actions button {
        margin-left: 0;
        margin-right: 8px;
        margin-top: 8px;
      }
      .popup,
      .goal-details-popup,
      #add-savings-popup {
        width: 90vw;
        padding: 20px;
      }
    }

    /* Cool text style for QR code section */
    .qr-cool-text {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: #a78bfa;
      text-align: center;
      margin-top: 12px;
      margin-bottom: 12px;
      text-shadow: 0 0 6px #a78bfa;
      user-select: none;
    }
  </style>
</head>

<body>
  <div class="max-w-md w-full">
    <h1 class="text-3xl font-bold text-center mb-8">üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h1>

    <button onclick="showAddGoalPopup()" class="add-new-goal-btn">
      ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
    </button>

    <div id="goals-list"></div>
  </div>

  <div id="add-goal-popup" class="popup" role="dialog" aria-modal="true" aria-labelledby="addGoalTitle">
    <h2 id="addGoalTitle" class="text-xl font-bold mb-4">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</h2>
    <div>
      <label for="new-target-name">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
      <input
        type="text"
        id="new-target-name"
        class="w-full p-2 mb-3 rounded"
        placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠"
        autocomplete="off"
      />
    </div>
    <div>
      <label for="new-target-price">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
      <input
        type="number"
        id="new-target-price"
        class="w-full p-2 mb-3 rounded"
        placeholder="‡πÄ‡∏ä‡πà‡∏ô 3000"
        min="0"
        step="0.01"
        autocomplete="off"
      />
    </div>
    <div>
      <label for="new-upload-image">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
      <input type="file" id="new-upload-image" accept="image/*" class="w-full mb-4" />
    </div>
    <button class="confirm" onclick="addNewGoal()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button class="cancel" onclick="hideAddGoalPopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>

  <div id="goal-details-popup" class="goal-details-popup" role="dialog" aria-modal="true" aria-labelledby="goalDetailsTitle">
    <h2 id="goalDetailsTitle"></h2>
    <div class="progress-ring-large my-4">
      <svg width="120" height="120" aria-label="Progress ring">
        <circle cx="60" cy="60" r="50" stroke-width="8" fill="none" />
        <circle
          id="details-progress-bar"
          cx="60"
          cy="60"
          r="50"
          stroke-width="8"
          fill="none"
          stroke-linecap="round"
          stroke-dasharray="314"
          stroke-dashoffset="314"
        />
      </svg>
      <text
        id="details-progress-percent"
        x="60"
        y="65"
        text-anchor="middle"
        font-size="20"
        aria-live="polite"
      ></text>
    </div>
    <p>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: <span id="details-target-price"></span> ‡∏ö‡∏≤‡∏ó</p>
    <p>‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß: <span id="details-saved-amount"></span> ‡∏ö‡∏≤‡∏ó</p>
    <p>‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å: <span id="details-remaining-amount" class="font-semibold"></span> ‡∏ö‡∏≤‡∏ó</p>
    <a href="history.html">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</a>
    <button onclick="closeGoalDetailsPopup()">‡∏õ‡∏¥‡∏î</button>
  </div>

  <script>
    let goals = JSON.parse(localStorage.getItem('savingGoals')) || [];
    const goalsListDiv = document.getElementById('goals-list');
    const addGoalPopup = document.getElementById('add-goal-popup');
    const goalDetailsPopup = document.getElementById('goal-details-popup');
    const detailsGoalName = document.getElementById('goalDetailsTitle');
    const detailsProgressBar = document.getElementById('details-progress-bar');
    const detailsProgressPercent = document.getElementById('details-progress-percent');
    const detailsTargetPrice = document.getElementById('details-target-price');
    const detailsSavedAmount = document.getElementById('details-saved-amount');
    const detailsRemainingAmount = document.getElementById('details-remaining-amount');

    function showAddGoalPopup() {
      addGoalPopup.style.display = 'block';
    }

    function hideAddGoalPopup() {
      addGoalPopup.style.display = 'none';
      document.getElementById('new-target-name').value = '';
      document.getElementById('new-target-price').value = '';
      document.getElementById('new-upload-image').value = '';
    }

    function addNewGoal() {
      const name = document.getElementById('new-target-name').value.trim();
      const price = parseFloat(document.getElementById('new-target-price').value);
      const imageFile = document.getElementById('new-upload-image').files[0];

      if (name && !isNaN(price) && price > 0) {
        if (imageFile) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const newGoal = {
              id: Date.now(),
              name: name,
              targetPrice: price,
              savedAmount: 0,
              imageUrl: e.target.result,
            };
            goals.unshift(newGoal);
            localStorage.setItem('savingGoals', JSON.stringify(goals));
            renderGoals();
            hideAddGoalPopup();
          };
          reader.readAsDataURL(imageFile);
        } else {
          const newGoal = {
            id: Date.now(),
            name: name,
            targetPrice: price,
            savedAmount: 0,
            imageUrl: 'https://placehold.co/80x80/png?text=No+Image&font=roboto',
          };
          goals.unshift(newGoal);
          localStorage.setItem('savingGoals', JSON.stringify(goals));
          renderGoals();
          hideAddGoalPopup();
        }
      } else {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
      }
    }

    function renderGoals() {
      goalsListDiv.innerHTML = '';
      goals.forEach((goal) => {
        const remaining = Math.max(goal.targetPrice - goal.savedAmount, 0);
        const goalDiv = document.createElement('div');
        goalDiv.classList.add('goal-item');
        goalDiv.innerHTML = `
          <div class="goal-image-container">
            <img src="${goal.imageUrl}" alt="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${goal.name} ‡∏Ç‡∏ô‡∏≤‡∏î 80x80 ‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•" class="goal-image" />
          </div>
          <div class="goal-details flex-grow min-w-0">
            <h3 class="font-semibold text-lg text-purple-600 truncate">${goal.name}</h3>
            <p class="text-gray-400 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤: ${goal.targetPrice.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
            <p class="text-gray-400 mb-1">‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ: <span id="saved-amount-${goal.id}">${goal.savedAmount.toLocaleString()}</span> ‡∏ö‡∏≤‡∏ó</p>
            <p class="text-green-400 font-semibold mb-2">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å: ${remaining.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
            <div class="goal-actions flex flex-wrap gap-2">
              <button onclick="showGoalDetails(${goal.id})" aria-label="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ${goal.name}">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
              <button onclick="showAddSavingsPopup(${goal.id}, '${escapeQuotes(
                goal.name
              )}')" class="bg-green-500 hover:bg-green-600" aria-label="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${goal.name}">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
              <button onclick="deleteGoal(${goal.id})" class="bg-red-500 hover:bg-red-600" aria-label="‡∏•‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ${goal.name}">‡∏•‡∏ö</button>
            </div>
          </div>
        `;
        goalsListDiv.appendChild(goalDiv);
      });
    }

    function escapeQuotes(str) {
      return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }

    function calculatePercentage(saved, target) {
      const percent = target > 0 ? (saved / target) * 100 : 0;
      return percent > 100 ? 100 : percent.toFixed(1);
    }

    function showGoalDetails(goalId) {
      const goal = goals.find((g) => g.id === goalId);
      if (goal) {
        detailsGoalName.innerText = goal.name;
        detailsTargetPrice.innerText = goal.targetPrice.toLocaleString();
        detailsSavedAmount.innerText = goal.savedAmount.toLocaleString();

        const remaining = Math.max(goal.targetPrice - goal.savedAmount, 0);
        detailsRemainingAmount.innerText = remaining.toLocaleString();

        const percent = calculatePercentage(goal.savedAmount, goal.targetPrice);
        detailsProgressBar.style.strokeDashoffset = 314 - (314 * percent) / 100;
        detailsProgressPercent.textContent = `${percent}%`;

        // Remove old QR code if any
        const oldQr = document.getElementById('qr-code-container');
        if (oldQr) oldQr.remove();

        goalDetailsPopup.style.display = 'block';
      }
    }

    function closeGoalDetailsPopup() {
      goalDetailsPopup.style.display = 'none';
      // Remove QR code container on close to avoid duplicates
      const oldQr = document.getElementById('qr-code-container');
      if (oldQr) oldQr.remove();
    }

    // PromptPay QR code generator helper functions
    // Reference: https://github.com/PromptPay/promptpay-qr/blob/master/README.md
    // This function builds the EMV QR string for PromptPay with amount

    function buildPromptPayPayload(mobileOrId, amount) {
      // mobileOrId: phone number or national ID (string)
      // amount: number (optional)

      // Helper to build TLV (Tag-Length-Value)
      function tlv(id, value) {
        const len = value.length.toString().padStart(2, '0');
        return id + len + value;
      }

      // Payload format:
      // Payload Format Indicator (ID "00") = "01"
      // Point of Initiation Method (ID "01") = "12" (dynamic QR with amount)
      // Merchant Account Information (ID "29") = TLV of:
      //   - GUI (ID "00") = "A000000677010111" (PromptPay)
      //   - Mobile or ID (ID "01") = mobileOrId
      // Transaction Currency (ID "53") = "764" (THB)
      // Transaction Amount (ID "54") = amount (optional)
      // Country Code (ID "58") = "TH"
      // CRC (ID "63") = CRC16 of all previous data + "6304"

      const payloadFormatIndicator = tlv('00', '01');
      const pointOfInitiationMethod = tlv('01', '12');

      const gui = tlv('00', 'A000000677010111');
      const merchantAccountInfo = tlv('29', gui + tlv('01', mobileOrId));

      const transactionCurrency = tlv('53', '764');
      const transactionAmount = amount ? tlv('54', amount.toFixed(2)) : '';
      const countryCode = tlv('58', 'TH');

      let rawPayload = payloadFormatIndicator + pointOfInitiationMethod + merchantAccountInfo + transactionCurrency + transactionAmount + countryCode;

      // Calculate CRC16-CCITT (0xFFFF initial value)
      function crc16ccitt(str) {
        let crc = 0xFFFF;
        for (let i = 0; i < str.length; i++) {
          crc ^= str.charCodeAt(i) << 8;
          for (let j = 0; j < 8; j++) {
            if ((crc & 0x8000) !== 0) {
              crc = (crc << 1) ^ 0x1021;
            } else {
              crc <<= 1;
            }
            crc &= 0xFFFF;
          }
        }
        return crc.toString(16).toUpperCase().padStart(4, '0');
      }

      const crc = crc16ccitt(rawPayload + '6304');
      const fullPayload = rawPayload + '6304' + crc;
      return fullPayload;
    }

    let currentGoalId = null;
    let currentGoalName = '';

    function showAddSavingsPopup(goalId, goalName) {
      currentGoalId = goalId;
      currentGoalName = goalName;

      const existingPopup = document.getElementById('add-savings-popup');
      if (existingPopup) {
        existingPopup.remove();
      }

      const popupDiv = document.createElement('div');
      popupDiv.id = 'add-savings-popup';
      popupDiv.classList.add('popup');
      popupDiv.setAttribute('role', 'dialog');
      popupDiv.setAttribute('aria-modal', 'true');
      popupDiv.setAttribute('aria-labelledby', 'addSavingsTitle');
      popupDiv.innerHTML = `
          <h2 id="addSavingsTitle" class="text-xl font-bold text-purple-600 mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "${goalName}"</h2>
          <div>
              <label for="add-amount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏ö‡∏≤‡∏ó)</label>
              <input type="number" id="add-amount" class="mb-4 w-full p-2 rounded-lg border-2 border-purple-300 focus:ring-2 focus:ring-purple-400" placeholder="‡πÄ‡∏ä‡πà‡∏ô 100" min="0.01" step="0.01" autocomplete="off" />
          </div>
          <button class="confirm" onclick="generatePromptPayQRCode()">‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</button>
          <button class="cancel" onclick="closeAddSavingsPopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <div id="qr-code-wrapper" class="mt-6 text-center hidden">
            <div class="qr-cool-text">‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô üí∏‚ú®</div>
            <canvas id="qr-code-canvas" aria-label="QR code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"></canvas>
            <div id="qr-amount-text" class="mt-2 text-green-400 font-semibold"></div>
            <button id="confirm-payment-btn" class="confirm mt-4 w-full">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>
          </div>
      `;
      document.body.appendChild(popupDiv);
      popupDiv.style.display = 'block';
      document.getElementById('add-amount').focus();

      // Hide confirm payment button initially
      document.getElementById('confirm-payment-btn').style.display = 'none';
      document.getElementById('confirm-payment-btn').onclick = confirmPaymentDone;
    }

    function closeAddSavingsPopup() {
      const popup = document.getElementById('add-savings-popup');
      if (popup) {
        popup.style.display = 'none';
        popup.remove();
      }
      currentGoalId = null;
      currentGoalName = '';
    }

    // PromptPay mobile number or ID for QR code generation
    // Updated to your number:
    const promptPayId = '0863185926';

    function generatePromptPayQRCode() {
      const amountInput = document.getElementById('add-amount');
      const amountToAdd = parseFloat(amountInput.value);
      if (isNaN(amountToAdd) || amountToAdd <= 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
        return;
      }

      const qrWrapper = document.getElementById('qr-code-wrapper');
      const qrCanvas = document.getElementById('qr-code-canvas');
      const qrAmountText = document.getElementById('qr-amount-text');
      const confirmPaymentBtn = document.getElementById('confirm-payment-btn');

      // Generate PromptPay payload string
      const payload = buildPromptPayPayload(promptPayId, amountToAdd);

      // Generate QR code on canvas
      QRCode.toCanvas(qrCanvas, payload, { width: 180, margin: 2, color: { dark: '#a78bfa', light: '#222' } }, function (error) {
        if (error) {
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code');
          console.error(error);
          qrWrapper.classList.add('hidden');
          confirmPaymentBtn.style.display = 'none';
          return;
        }
        qrWrapper.classList.remove('hidden');
        qrAmountText.textContent = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ${amountToAdd.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó`;
        confirmPaymentBtn.style.display = 'block';
      });

      // Disable inputs and buttons except cancel and confirm payment
      amountInput.disabled = true;
      document.querySelector('#add-savings-popup button.confirm').disabled = true;
    }

    function confirmPaymentDone() {
      const amountInput = document.getElementById('add-amount');
      const amountToAdd = parseFloat(amountInput.value);
      if (isNaN(amountToAdd) || amountToAdd <= 0 || currentGoalId === null) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        return;
      }

      let updatedGoal;
      goals = goals.map((goal) => {
        if (goal.id === currentGoalId) {
          goal.savedAmount += amountToAdd;
          updatedGoal = goal;
        }
        return goal;
      });
      localStorage.setItem('savingGoals', JSON.stringify(goals));
      renderGoals();
      closeAddSavingsPopup();

      if (updatedGoal) {
        const now = new Date();
        const date = now.toLocaleDateString('th-TH');
        const time = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        const percent = calculatePercentage(updatedGoal.savedAmount, updatedGoal.targetPrice);

        const historyRecord = {
          date: date,
          time: time,
          goalName: updatedGoal.name,
          amount: amountToAdd,
          percent: percent,
          imageUrl: updatedGoal.imageUrl,
          targetAmount: updatedGoal.targetPrice,
        };

        let savingHistory = JSON.parse(localStorage.getItem('savingHistory')) || [];
        savingHistory.unshift(historyRecord);
        localStorage.setItem('savingHistory', JSON.stringify(savingHistory));
      }
    }

    function deleteGoal(goalId) {
      if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        goals = goals.filter((goal) => goal.id !== goalId);
        localStorage.setItem('savingGoals', JSON.stringify(goals));
        renderGoals();
      }
    }

    renderGoals();
  </script>
</body>
</html>
